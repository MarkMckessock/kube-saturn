---
version: "3"

x-task-vars: &task-vars
  dbUser: '{{.dbUser}}'
  dbName: '{{.dbName}}'
  dbPassword: '{{.dbPassword}}'

vars:
  initdb_template: "{{.ROOT_DIR}}/.taskfiles/init-db.tmpl.yaml"

tasks:
  init-db:
    desc: Create a new cloudnative-pg database with a provided user
    cmds:
      - envsubst < <(cat "{{.initdb_template}}") | kubectl apply -f -
    env: *task-vars
    vars:
      dbUser: '{{ or .dbUser (fail "Database User is required") }}'
      dbName: '{{ or .dbName (fail "Database name is required") }}'
      dbPassword: '{{ or .dbPassword (fail "Database password is required") }}'
