---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: plex-meta-manager-config
  namespace: media
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: plex-meta-manager-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        config.yaml: |-
          libraries:
            Movies:
              collection_files:
                - file: /collections/movies-movies.yaml
                - file: /collections/movies-charts.yaml
                - file: /collections/movies-holidays.yaml
                - file: /collections/movies-studios.yaml
              operations:
                delete_collections:
                  configured: false
                  managed: true
            TV Shows:
              collection_files:
                - file: /collections/tv-charts.yaml
              operations:
                delete_collections:
                  configured: false
                  managed: true

          settings:
            cache: true
            cache_expiration: 60
            asset_directory: /config/assets
            asset_folders: true
            create_asset_folders: true
            sync_mode: append
            show_unmanaged: true
            show_filtered: false
            show_missing: true
            show_missing_assets: true
            save_missing: true
            run_again_delay: 2
            missing_only_released: false
            only_filter_missing: false
            collection_minimum: 1
            delete_below_minimum: true
            delete_not_scheduled: false
            tvdb_language: eng

          plex:
            url: http://plex.media.svc:32400
            token: {{ .PLEX_TOKEN }}
            timeout: 60
            clean_bundles: false
            empty_trash: false
            optimize: false
          tmdb:
            apikey: {{ .tmdb_api_key }}
            language: en
          omdb:
            apikey: {{ .omdb_api_key }}
          radarr:                                         # Can be individually specified per library as well
            url: http://radarr:7878
            token: {{ .RADARR_API_KEY }}
            add: false
            root_folder_path: "/media/movies/main/<4K"
            monitor: true
            availability: announced
            quality_profile: HD-1080p
            tag:
            search: false
          sonarr:                                         # Can be individually specified per library as well
            url: http://sonarr:8989
            token: {{ .SONARR_API_KEY }}
            add: false
            root_folder_path: "/media/tv shows"
            monitor: all
            quality_profile: HD-1080p
            language_profile: English
            series_type: standard
            season_folder: true
            tag:
            search: false
            cutoff_search: false
  dataFrom:
    - extract:
        key: plex-meta-manager
  data:
    - secretKey: PLEX_TOKEN
      remoteRef:
        key: plex-claim-token
        property: password
    - secretKey: SONARR_API_KEY
      remoteRef:
        key: sonarr
        property: SONARR_API_KEY
    - secretKey: RADARR_API_KEY
      remoteRef:
        key: radarr
        property: RADARR_API_KEY
