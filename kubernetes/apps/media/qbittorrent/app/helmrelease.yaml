---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app qbittorrent
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    defaultPodOptions:
      automountServiceAccountToken: false
    controllers:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          main:
            image:
              repository: ghcr.io/home-operations/qbittorrent
              tag: 5.0.4@sha256:995c561247b069c10b1fa098186f35b3155c2df63912041f70637a9232755756
            env:
              QBT_TORRENTING_PORT: &bittorrentPort 50413
              QBT_WEBUI_PORT: &port 8080
              TZ: America/Los_Angeles
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api/v2/app/version
                    port: *port
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 10
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 8Gi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
          gluetun:
            dependsOn: main
            image:
              repository: ghcr.io/qdm12/gluetun
              tag: latest
            env:
              VPN_SERVICE_PROVIDER: "private internet access"
              SERVER_REGIONS: "CA Vancouver"
              PORT_FORWARD_ONLY: "true"
              VPN_PORT_FORWARDING: "on"
              VPN_PORT_FORWARDING_STATUS_FILE: "/tmp/gluetun/forwarded_port"
            envFrom:
              - secretRef:
                  name: pia-vpn-credentials
            securityContext:
              capabilities:
                add:
                  - NET_ADMIN
          port-forward:
            dependsOn: gluetun
            image:
              repository: docker.io/snoringdragon/gluetun-qbittorrent-port-manager
              tag: "1.0"
            env:
              - name: QBITTORRENT_SERVER
                value: localhost
              - name: QBITTORRENT_PORT
                value: "8080"
              - name: PORT_FORWARDED
                value: "/tmp/gluetun/forwarded_port"
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [65536]
    route:
      app:
        hostnames:
          - "{{ .Release.Name }}.markmckessock.com"
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https
        rules:
          - backendRefs:
              - name: *app
                port: *port
    service:
      main:
        controller: main
        type: ClusterIP
        ports:
          http:
            port: 8080
    persistence:
      config:
        existingClaim: *app
      downloads:
        type: nfs
        server: granite.markmckessock.com
        path: /volume1/Downloads
        globalMounts:
          - path: /complete
      media:
        type: nfs
        server: granite.markmckessock.com
        path: /volume1/Media
        globalMounts:
          - path: /media
      gluetun-data:
        type: emptyDir
        advancedMounts:
          main:
            gluetun:
              - path: /tmp/gluetun
            port-forward:
              - path: /tmp/gluetun
                readOnly: true



    # controllers:
    #   qbittorrent:
    #     annotations:
    #       reloader.stakater.com/auto: "true"
    #     containers:
    #       main:
    #         image:
    #           repository: binhex/arch-qbittorrentvpn
    #           tag: 5.0.4-3-01
    #         env:
    #           TZ: "America/Toronto"
    #           PUID: 1000
    #           PGID: 1000
    #           ENABLE_PRIVOXY: "no"
    #           DEBUG: "true"
    #           VPN_ENABLED: "yes"
    #           LAN_NETWORK: 10.0.0.0/16,192.168.1.0/24
    #           WEBUI_PORT: 8080
    #           STRICT_PORT_FORWARD: "yes"
    #           QBT_TORRENTING_PORT: &bittorrentPort 50413
    #           QBT_WEBUI_PORT: &port 8080
    #           NAME_SERVERS: 1.1.1.1,1.0.0.1,8.8.8.8
    #           VPN_CLIENT: wireguard
    #           VPN_PROV: pia
    #         securityContext:
    #           privileged: true
    #           capabilities:
    #             add: ["NET_ADMIN"]
    #         probes:
    #           liveness: &probes
    #             enabled: true
    #             custom: true
    #             spec:
    #               httpGet:
    #                 path: /api/v2/app/version
    #                 port: *port
    #               initialDelaySeconds: 0
    #               periodSeconds: 10
    #               timeoutSeconds: 1
    #               failureThreshold: 3
    #           readiness: *probes
    #           startup:
    #             enabled: true
    #             spec:
    #               failureThreshold: 30
    #               periodSeconds: 10
    #         envFrom:
    #           - secretRef:
    #               name: pia-vpn-credentials
    #         resources:
    #           requests:
    #             cpu: 10m
    #             memory: 250Mi
    #           limits:
    #             memory: 6000Mi
    # service:
    #   app:
    #     controller: *app
    #     nameOverride: *app
    #     ports:
    #       http:
    #         port: *port
    #   bittorrent:
    #     controller: *app
    #     type: LoadBalancer
    #     annotations:
    #       lbipam.cilium.io/ips: 10.0.70.95
    #     ports:
    #       bittorrent-tcp:
    #         port: *bittorrentPort
    #         protocol: TCP
    # route:
    #   app:
    #     hostnames:
    #       - "{{ .Release.Name }}.markmckessock.com"
    #     parentRefs:
    #       - name: external
    #         namespace: kube-system
    #         sectionName: https
    #     rules:
    #       - backendRefs:
    #           - name: *app
    #             port: *port
