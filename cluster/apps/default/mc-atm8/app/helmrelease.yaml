---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: mc-atm8
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 2.3.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  timeout: 15m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controller:
      annotations:
        reloader.stakater.com/auto: "true"

    image:
      repository: itzg/minecraft-server
      tag: java17

    env:
      EULA: "true"
      TYPE: AUTO_CURSEFORGE
      CF_SLUG: all-the-mods-8
      CF_FILENAME_MATCHER: "1.0.15"
      DIFFICULTY: hard
      OVERRIDE_SERVER_PROPERTIES: "true"
      MAX_PLAYERS: 50
      MOTD: "Minecraft ATM 8"
      SPAWN_PROTECTION: 0
      ALLOW_FLIGHT: "true"
      PVP: "true"
      MEMORY: 12G
      # ENFORCE_WHITELIST: "true"
      # WHITELIST: player,name
      # OPS: player,name
    envFrom:
      - secretRef:
          name: curseforge-api-key

    service:
      main:
        type: LoadBalancer
        loadBalancerIP: ${MC_SERVER_IP}
        externalTrafficPolicy: Local
        ports:
          http:
            enabled: false
            primary: false
          minecraft:
            enabled: true
            primary: true
            port: &port 25565
            protocol: TCP

    initContainers:
      modpack:
        image: alpine
        command:
          [
            "/bin/sh",
            "-c",
            "wget -O /mods/hexerei-0.2.5.jar https://mediafilez.forgecdn.net/files/4035/671/hexerei-0.2.5.jar && wget -O /mods/ExperienceBugFix-1.19-1.41.2.3.jar https://mediafilez.forgecdn.net/files/4178/188/ExperienceBugFix-1.19-1.41.2.3.jar && wget -O /mods/moreoverlays-1.21.5-mc1.19.2.jar https://mediafilez.forgecdn.net/files/4322/445/moreoverlays-1.21.5-mc1.19.2.jar",
          ]
        volumeMounts:
          - name: mods
            mountPath: /mods

    persistence:
      data:
        enabled: true
        type: pvc
        size: 5Gi
        accessMode: ReadWriteOnce
        mountPath: /data
        storageClass: ceph-block
        retain: true
      mods:
        enabled: true
        type: emptyDir
        mountPath: /mods

    securityContext:
      runAsUser: 1000
      fsGroup: 2000

    probes:
      liveness:
        custom: true
        spec:
          exec:
            command: ["mc-health"]
          periodSeconds: 5
          failureThreshold: 6
      readiness:
        custom: true
        spec:
          exec:
            command: ["mc-health"]
          periodSeconds: 5
          failureThreshold: 6
      startup:
        custom: true
        spec:
          exec:
            command: ["mc-health"]
          periodSeconds: 10
          failureThreshold: 60

    resources:
      requests:
        cpu: 2000m
        memory: 16000Mi
      limits:
        memory: 16000Mi
