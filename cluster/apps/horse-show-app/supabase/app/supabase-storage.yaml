---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: supabase-storage
  namespace: horse-show-app
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    image:
      repository: supabase/storage-api
      tag: v0.37.3

    env:
      ANON_KEY:
        valueFrom:
          secretKeyRef:
            name: supabase-jwt
            key: anonKey
      SERVICE_KEY:
        valueFrom:
          secretKeyRef:
            name: supabase-jwt
            key: serviceKey
      POSTGREST_URL: http://supabase-supabase-rest:3000
      PGRST_JWT_SECRET:
        valueFrom:
          secretKeyRef:
            name: supabase-jwt
            key: secret
      DATABASE_URL:
        valueFrom:
          secretKeyRef:
            name: supabase-db
            key: DATABASE_URL
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      # TODO: https://github.com/supabase/storage-api/issues/55
      REGION: stub
      GLOBAL_S3_BUCKET: stub
      ENABLE_IMAGE_TRANSFORMATION: "true"
      IMGPROXY_URL: http://supabase-imgproxy:5001

    service:
      main:
        ports:
          http:
            port: 5000

    initContainers:
      init-db:
        name: init-db
        image: postgres:15-alpine
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
        - |
          until pg_isready -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER); do
          echo "Waiting for database to start..."
          sleep 2
          done
        - echo "Database is ready"
        env:
        - name: DB_HOST
          value: supabase-db.horse-show-app.svc.cluster.local
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: supabase-db

    persistence:
      storage:
        enabled: true
        mountPath: /var/lib/storage
        type: pvc
        existingClaim: supabase-storage

    resources:
      requests:
        cpu: 10m
        memory: 1000Mi
      limits:
        memory: 1000Mi
