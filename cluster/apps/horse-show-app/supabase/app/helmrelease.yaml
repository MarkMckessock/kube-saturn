---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: supabase
  namespace: horse-show-app
spec:
  interval: 15m
  chart:
    spec:
      chart: supabase
      version:  0.1.5
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  values:
    global:
      jwt:
        existingSecret: supabase-jwt
        existingSecretKey: secret
        existingSecretAnonKet: anonKey
        existingSecretServiceKey: serviceKey
      storageClass: ceph-block

    publicURL: https://api.markmckessock.com

    auth:
      defaultConfig: |
        GOTRUE_API_HOST: "0.0.0.0"
        GOTRUE_API_PORT: {{ .Values.auth.containerPorts.http | quote }}
        GOTRUE_SITE_URL: {{ include "supabase.studio.publicURL" . | quote }}
        GOTRUE_URI_ALLOW_LIST: "*"
        GOTRUE_DISABLE_SIGNUP: "false"
        GOTRUE_DB_DRIVER: "postgres"
        GOTRUE_JWT_DEFAULT_GROUP_NAME: "authenticated"
        GOTRUE_JWT_ADMIN_ROLES: "service_role"
        GOTRUE_JWT_AUD: "authenticated"
        GOTRUE_JWT_EXP: "3600"
        GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
        GOTRUE_MAILER_AUTOCONFIRM: "true"
        GOTRUE_SMTP_ADMIN_EMAIL: "mark.mckessock@gmail.com"
        GOTRUE_SMTP_HOST: "smtp.gmail.com"
        GOTRUE_SMTP_PORT: "587"
        GOTRUE_SMTP_SENDER_NAME: "Supabase"
        GOTRUE_EXTERNAL_PHONE_ENABLED: "false"
        GOTRUE_SMS_AUTOCONFIRM: "false"
        GOTRUE_MAILER_URLPATHS_INVITE: "{{ include "supabase.studio.publicURL" . }}/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_CONFIRMATION: "{{ include "supabase.studio.publicURL" . }}/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_RECOVERY: "{{ include "supabase.studio.publicURL" . }}/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: "{{ include "supabase.studio.publicURL" . }}/auth/v1/verify"

    realtime:
      existingSecret: supabase-realtime
      existingSecretKey: SECRET_KEY_BASE

    storage:
      persistence:
        storageClass: ceph-block

    studio:
      publicURL: https://supabase.markmckessock.com
      ingress:
        enabled: true
        hostname: supabase.markmckessock.com
        ingressClassName: nginx
        tls: true

    kong:
      ingress:
        enabled: true
        hostname: api.markmckessock.com
        tls: true

    postgresql:
      auth:
        existingSecret: supabase-db


