---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: supabase
  namespace: horse-show-app
spec:
  interval: 15m
  chart:
    spec:
      chart: ./charts/supabase
      sourceRef:
        kind: GitRepository
        name: supabase-kubernetes
        namespace: flux-system
  values:
    jwt:
      secretName: supabase-jwt
    smtp:
      secretName: supabase-smtp

    db:
      enabled: false
      secretName: supabase-db
      persistence:
        enabled: false

    studio:
      image:
        repository: supabase/studio
        pullPolicy: IfNotPresent
        tag: "20230330-99fed3d"
      environment:
        SUPABASE_URL: https://api.markmckessock.com
        SUPABASE_REST_URL: https://api.markmckessock.com/rest/v1/
        STUDIO_PG_META_URL: http://supabase-kong.horse-show-app.svc.cluster.local:8000/pg
      ingress:
        hosts:
          - host: supabase.markmckessock.com
            paths:
              - path: /
                pathType: Prefix
                backend:
                  serviceName: api
                  servicePort: 3000
        tls:
          - secretName: supabase.markmckessock.com
            hosts:
              - supabase.markmckessock.com

    auth:
      enabled: false

    rest:
      image:
        repository: postgrest/postgrest
        pullPolicy: IfNotPresent
        tag: "v10.2.0"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: allow # disable, allow, prefer, require, verify-ca, verify-full
        PGRST_DB_SCHEMA: public,storage
        PGRST_DB_ANON_ROLE: anon
        PGRST_DB_USE_LEGACY_GUCS: "false"

    realtime:
      enabled: false

    meta:
      image:
        repository: supabase/postgres-meta
        pullPolicy: IfNotPresent
        tag: "v0.64.6"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: allow # disable, allow, prefer, require, verify-ca, verify-full
        PG_META_PORT: "8080"

    storage:
      enabled: false

    kong:
      image:
        repository: kong
        pullPolicy: IfNotPresent
        tag: "2.8.1"
      environment:
        KONG_DATABASE: "off"
        KONG_DECLARATIVE_CONFIG: /home/kong/kong.yml
        # https://github.com/supabase/cli/issues/14
        KONG_DNS_ORDER: LAST,A,CNAME
        KONG_PLUGINS: request-transformer,cors,key-auth,acl
        KONG_LOG_LEVEL: debug
      ingress:
        tls:
          - secretName: api.markmckessock.com
            hosts:
              - api.markmckessock.com
        hosts:
          - host: api.markmckessock.com
            paths:
              - path: /
                pathType: Prefix
                backend:
                  serviceName: api
                  servicePort: 80
