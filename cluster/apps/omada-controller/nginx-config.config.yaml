apiVersion: v1
kind: ConfigMap
metadata:
    name: nginx-config
    namespace: omada-controller
data:
    nginx.conf: |
        events { }

        http {
            server {
                listen 80 default_server;
                listen [::]:80 default_server;
                server_name _;
                return 301 https://$host$request_uri;
            }

            server {
                listen 443 ssl;
                server_name omada.${DOMAIN};

                ssl_certificate     /etc/ssl/certs/tls.crt;
                ssl_certificate_key /etc/ssl/certs/tls.key;

                set $backend https://127.0.0.1:8043;

                location / {
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header Referer $http_referer;
                  proxy_set_header X-Forwarded-For $remote_addr;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_pass $backend;
                }

                location /login {
                  rewrite /login/$1 /tp/login(.*);
                  proxy_pass $backend/login;
                  proxy_redirect https://$proxy_host/login $scheme://$host:$server_port/login;
                  sub_filter 'href="/login' 'href="/tp/login';
                }

                location /js {
                  proxy_pass $backend/js;
                }

                location /api {
                  proxy_pass $backend/api;
                }
            }
        }