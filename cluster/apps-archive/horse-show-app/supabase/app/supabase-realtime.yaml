---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: supabase-realtime
  namespace: horse-show-app
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    image:
      repository: supabase/realtime
      tag: v2.5.1

    command: ["sh", "-c", "/app/bin/migrate && /app/bin/realtime eval 'Realtime.Release.seeds(Realtime.Repo)' && /app/bin/server"]

    env:
      PORT: &port 4000
      DB_HOST: supabase-db.horse-show-app.svc.cluster.local
      DB_PORT: 5432
      DB_USER: supabase_admin
      DB_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: supabase-db
            key: password
      DB_NAME: supabase
      DB_AFTER_CONNECT_QUERY: 'SET search_path TO _realtime'
      API_JWT_SECRET:
        valueFrom:
          secretKeyRef:
            name: supabase-jwt
            key: secret
      FLY_ALLOC_ID: fly123
      FLY_APP_NAME: realtime
      ERL_AFLAGS: -proto_dist inet_tcp
      ENABLE_TAILSCALE: "false"
      DNS_NODES: "''"

    envFrom:
      - secretRef:
          name: supabase-realtime

    service:
      main:
        ports:
          http:
            port: *port

    initContainers:
      init-db:
        name: init-db
        image: postgres:15-alpine
        imagePullPolicy: IfNotPresent
        command: ["/bin/sh", "-c"]
        args:
        - |
          until pg_isready -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER); do
          echo "Waiting for database to start..."
          sleep 2
          done
        - echo "Database is ready"
        env:
        - name: DB_HOST
          value: supabase-db.horse-show-app.svc.cluster.local
        - name: DB_PORT
          value: "5432"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: username
              name: supabase-db



    resources:
      requests:
        cpu: 10m
        memory: 1000Mi
      limits:
        memory: 1000Mi
