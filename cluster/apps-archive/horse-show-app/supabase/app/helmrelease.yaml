---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: supabase
  namespace: horse-show-app
spec:
  interval: 15m
  chart:
    spec:
      chart: ./charts/supabase
      sourceRef:
        kind: GitRepository
        name: supabase-kubernetes
        namespace: flux-system
  valuesFrom:
    - kind: Secret
      name: supabase-realtime
      valuesKey: SECRET_KEY_BASE
      targetPath: realtime.environment.SECRET_KEY_BASE
    - kind: Secret
      name: supabase-realtime
      valuesKey: DB_ENC_KEY
      targetPath: realtime.environment.DB_ENC_KEY

  values:
    jwt:
      secretName: supabase-jwt
    smtp:
      secretName: supabase-smtp

    db:
      enabled: false
      image:
        repository: supabase/postgres
        tag: 15.1.0.54-rc0
      secretName: supabase-db
      persistence:
        enabled: false

    studio:
      image:
        repository: supabase/studio
        pullPolicy: IfNotPresent
        tag: "20230330-99fed3d"
      environment:
        SUPABASE_URL: https://api.markmckessock.com
        SUPABASE_REST_URL: https://api.markmckessock.com/rest/v1/
        STUDIO_PG_META_URL: http://supabase-supabase-kong.horse-show-app.svc.cluster.local:8000/pg
        SUPABASE_PUBLIC_URL: "https://api.markmckessock.com"
      ingress:
        hosts:
          - host: supabase.markmckessock.com
            paths:
              - path: /
                pathType: Prefix
                backend:
                  serviceName: api
                  servicePort: 3000
        tls:
          - secretName: supabase.markmckessock.com
            hosts:
              - supabase.markmckessock.com

    auth:
      image:
        repository: supabase/gotrue
        pullPolicy: IfNotPresent
        tag: "v2.60.8"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: disable
        GOTRUE_API_HOST: "0.0.0.0"
        GOTRUE_API_PORT: "9999"
        GOTRUE_SITE_URL: https://supabase.markmckessock.com
        GOTRUE_URI_ALLOW_LIST: "*"
        GOTRUE_DISABLE_SIGNUP: "false"
        GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
        GOTRUE_JWT_ADMIN_ROLES: service_role
        GOTRUE_JWT_AUD: authenticated
        GOTRUE_JWT_EXP: "3600"
        GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
        GOTRUE_MAILER_AUTOCONFIRM: "true"
        GOTRUE_SMTP_ADMIN_EMAIL: "mark.mckessock@gmail.com"
        GOTRUE_SMTP_HOST: "smtp.gmail.com"
        GOTRUE_SMTP_PORT: "465"
        GOTRUE_SMTP_SENDER_NAME: "Supabase"
        GOTRUE_EXTERNAL_PHONE_ENABLED: "false"
        GOTRUE_SMS_AUTOCONFIRM: "false"
        GOTRUE_MAILER_URLPATHS_INVITE: "https://api.markmckessock.com/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_CONFIRMATION: "https://api.markmckessock.com/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_RECOVERY: "https://api.markmckessock.com/auth/v1/verify"
        GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: "https://api.markmckessock.com/auth/v1/verify"

    rest:
      image:
        repository: postgrest/postgrest
        pullPolicy: IfNotPresent
        tag: "v10.1.2"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: disable
        PGRST_DB_SCHEMA: public,storage
        PGRST_DB_ANON_ROLE: anon
        PGRST_DB_USE_LEGACY_GUCS: "false"

    realtime:
      enabled: false

    meta:
      image:
        repository: supabase/postgres-meta
        pullPolicy: IfNotPresent
        tag: "v0.60.7"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: disable
        PG_META_PORT: "8080"

    storage:
      image:
        repository: supabase/storage-api
        pullPolicy: IfNotPresent
        tag: "v0.48.4"
      environment:
        DB_HOST: supabase-db.horse-show-app.svc.cluster.local
        DB_USER: supabase_storage_admin
        DB_PORT: "5432"
        DB_DRIVER: postgres
        DB_NAME: supabase
        DB_SSL: disable
        POSTGREST_URL: http://supabase-supabase-rest.horse-show-app.svc.cluster.local:3000
        PGOPTIONS: -c search_path=storage,public
        FILE_SIZE_LIMIT: '52428800'
        STORAGE_BACKEND: file
        FILE_STORAGE_BACKEND_PATH: /var/lib/storage
        TENANT_ID: stub
        REGION: stub
        GLOBAL_S3_BUCKET: stub
      persistence:
        enabled: true
        storageClassName: "ceph-block"
        size: 10Gi
        accessModes:
          - ReadWriteOnce
        annotations:
          helm.sh/resource-policy: "keep"

    kong:
      image:
        repository: kong
        pullPolicy: IfNotPresent
        tag: "2.8.1"
      environment:
        KONG_DATABASE: "off"
        KONG_DECLARATIVE_CONFIG: /home/kong/kong.yml
        # https://github.com/supabase/cli/issues/14
        KONG_DNS_ORDER: LAST,A,CNAME
        KONG_PLUGINS: request-transformer,cors,key-auth,acl
        KONG_LOG_LEVEL: debug
      ingress:
        tls:
          - secretName: api.markmckessock.com
            hosts:
              - api.markmckessock.com
        hosts:
          - host: api.markmckessock.com
            paths:
              - path: /
                pathType: Prefix
                backend:
                  serviceName: api
                  servicePort: 80
